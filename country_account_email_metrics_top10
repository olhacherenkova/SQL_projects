WITH account_table AS (SELECT ses.date,
sp.country,
ac.send_interval,
ac.is_verified,
ac.is_unsubscribed,
COUNT (DISTINCT ac.id) AS account_cnt
FROM `data-analytics-mate.DA.account` ac
JOIN `DA.account_session` acs
ON ac.id=acs.account_id
JOIN `DA.session` ses
ON acs.ga_session_id = ses.ga_session_id
JOIN `DA.session_params` sp
ON acs.ga_session_id = sp.ga_session_id
GROUP BY 1,2,3,4,5),
--
account_metric AS (
SELECT account_table.country,
SUM (account_table.account_cnt) AS total_country_account_cnt,
DENSE_RANK() OVER (ORDER BY SUM (account_table.account_cnt) DESC) AS rank_total_country_account_cnt
FROM account_table
GROUP BY 1),
--
email_table AS(
SELECT DATE_ADD(ses.date, INTERVAL es.sent_date DAY) AS date,
sp.country,
ac.send_interval,
ac.is_verified,
ac.is_unsubscribed,
COUNT (DISTINCT es.id_message) AS sent_msg,
COUNT (DISTINCT eo.id_message) AS open_msg,
COUNT (DISTINCT ev.id_message) AS visit_msg
FROM `data-analytics-mate.DA.account` ac
JOIN `DA.email_sent` es
ON ac.id= es.id_account
LEFT JOIN `DA.email_open` eo
ON es.id_message= eo.id_message
LEFT JOIN  `DA.email_visit` ev
ON es.id_message= ev.id_message
JOIN `DA.account_session` acs
ON ac.id = acs.account_id
JOIN `DA.session` ses
ON acs.ga_session_id = ses.ga_session_id
JOIN `DA.session_params` sp
ON acs.ga_session_id = sp.ga_session_id
GROUP BY 1,2,3,4,5),
--
email_metric AS (SELECT email_table.country,
SUM (email_table.sent_msg) AS total_country_sent_cnt,
DENSE_RANK() OVER (order by SUM (email_table.sent_msg) DESC) AS rank_total_country_sent_cnt
FROM email_table
GROUP BY 1),
--
union_table AS (
SELECT
date,
account_table.country,
send_interval,
is_verified,
is_unsubscribed,
account_cnt,
0 AS sent_msg,
0 AS open_msg,
0 AS visit_msg
FROM account_table
UNION ALL
SELECT
date,
email_table.country,
send_interval,
is_verified,
is_unsubscribed,
0 AS account_cnt,
sent_msg,
open_msg,
visit_msg
FROM email_table),
--
fin_table AS (SELECT
date,
country,
send_interval,
is_verified,
is_unsubscribed,
SUM (account_cnt) AS account_cnt,
SUM (sent_msg) AS sent_msg,
SUM (open_msg) AS open_msg,
SUM (visit_msg) AS visit_msg
FROM union_table
GROUP BY 1,2,3,4,5)


SELECT
date,
fin_table.country,
send_interval,
is_verified,
is_unsubscribed,
account_cnt,
sent_msg,
open_msg,
visit_msg,
total_country_account_cnt,
total_country_sent_cnt,
rank_total_country_account_cnt,
rank_total_country_sent_cnt
FROM fin_table
JOIN account_metric
ON fin_table.country = account_metric.country
JOIN email_metric
ON fin_table.country = email_metric.country
WHERE rank_total_country_account_cnt <=10 OR rank_total_country_sent_cnt <=10
